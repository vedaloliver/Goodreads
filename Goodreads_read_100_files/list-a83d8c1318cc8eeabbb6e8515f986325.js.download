function handleTipMouseout(e,t,n){null!=e.relatedTarget&&e.relatedTarget.id!=n&&(e.relatedTarget.up("#"+n)||(window.tipTimers[t]&&(clearTimeout(window.tipTimers[t]),window.tipTimers[t]=null),$(t).hide()))}function selectAllReviews(){$$("#books .bookalike").each(function(e){e.fastHasClassName("selected")||e.simulate("click")})}function unSelectAllReviews(){selectAllReviews(),$$("#books .bookalike").each(function(e){e.fastHasClassName("selected")&&e.simulate("click")})}function checkInfiniteFooter(){var e=$("pagestuff").cumulativeOffset()[1]+$("pagestuff").cumulativeScrollOffset()[1];!$("pagestuff").fastHasClassName("anchored")&&$$(".footerContainer")[0].cumulativeOffset()[1]-e<$("pagestuff").getHeight()?$("pagestuff").fastAddClassName("anchored"):$("pagestuff").fastHasClassName("anchored")&&$("pagestuff").fastRemoveClassName("anchored")}function updateSessionShelfSettings(){new Ajax.Request("/review/update_session_shelf_settings",{parameters:$("fieldsForm").serialize()})}function switchView(e,t){for(var n=["covers","table"],i=n.length-1;i>=0;i--)$("books").removeClassName(n[i]);return $("books").addClassName(t),!1}function toggleFieldsToMatchHeader(){for(var e=$$("#booksHeader th").length-1;e>=0;e--){var t=$$("#booksHeader th")[e];t.visible()?$$(".field."+t.getAttribute("alt")).invoke("show"):$$(".field."+t.getAttribute("alt")).invoke("hide")}}function showColumns(e,t){var e=e||[],t=t||{};$$('#fieldsForm input[name^="shelf[display_fields]"]').each(function(t){("cover"!=t.alt||"covers"!=VIEW)&&(t.checked=e.include(t.alt),$$(".field."+t.alt).invoke(t.checked?"show":"hide"))}),$("fieldsForm").down("input").simulate("change"),updateFieldSet(t.fieldSet)}function updateFieldSet(e){var t=e||"custom";$$("#presetFields a").each(function(e){e.id==t+"FieldSetLink"?$(e).addClassName("selected"):$(e).removeClassName("selected")})}function showControl(e){var t=e.id;if("string"==typeof e&&(t=e),!$(e).hasClassName("open")){var n=t.replace("Link","");$$(".controlLink").each(function(e){e.id!=t&&hideControl(e)}),$(e).addClassName("open"),$(n).show(),"batchEdit"==n&&startEditing()}}function hideControl(e){var t=e.id;if("string"==typeof e&&(t=e),$(e).hasClassName("open")){var n=t.replace("Link","");$(n).visible()&&($(e).removeClassName("open"),$(n).hide(),"batchEdit"==n&&stopEditing())}}function toggleControl(e){var t=e.id,n=t.replace("Link","");$(n).visible()?hideControl(e):showControl(e)}function startEditing(e){var e=e||{};null!=typeof DRAGGABLE_REORDER&&null==e.sortable&&(e.sortable=DRAGGABLE_REORDER),$("books").addClassName("editable"),$("batchEditLink").addClassName("selected"),$$("#books .checkbox").invoke("show"),$$(".bookalike").invoke("labelize",{hoverClass:"checkable",selectedClass:"selected"}),$("reorderLink")&&$("reorderLink").hide(),1==e.sortable&&0!=$$(".bookalike .position input").length&&(Prototype.Browser.IE||($("books").addClassName("sortable"),Sortable.create("booksBody",{tag:"div",only:"bookalike",onUpdate:function(){window.justSorted=!0;var e=Sortable.sequence("booksBody").map(function(e,t){var n=$("review_"+e).down(".position input"),i=n.id.split("_"),o=i[i.length-1];return"positions["+o+"]="+(t+1)}).join("&");e+="&no_content=true",new Ajax.Request("/shelf/move_batch",{parameters:e,evalJS:!1})}}),$$(".bookalike").each(function(e){e.hasClassName("review")&&new Draggable(e,{revert:!0,onStart:function(e,t){$(e.element).addClassName("dragging")},onEnd:function(e,t){$(e.element).removeClassName("dragging")}})})))}function stopEditing(){$("books").removeClassName("editable"),$("books").removeClassName("sortable"),$("batchEditLink").removeClassName("selected"),$$("#books .checkbox").invoke("hide"),$$(".bookalike").invoke("delabelize",{hoverClass:"checkable",selectedClass:"selected"}),$("reorderLink")&&$("reorderLink").show()}function toggleEditing(e){$("batchEdit").visible()?stopEditing(e):startEditing(e)}function savePositionChanges(e){new Ajax.Request("/shelf/move_batch/"+e,{parameters:Form.serializeElements($$("#books .position input"))+"&view="+VIEW,onLoading:function(){$$("#books .position .position_loading").invoke("show"),$$("#books .position input").invoke("hide"),Tips.hideAll()},onSuccess:function(e){$("booksBody").update(e.responseJSON.html),toggleFieldsToMatchHeader(),$("batchEdit").visible()&&startEditing(),$("reorderConfirm").hide(),$("booksBody").highlight()},onComplete:function(e){$$("#books .position .position_loading").invoke("hide"),$$("#books .position input").invoke("show")},onFailure:function(){alert("Something went wrong re-ordering those shelves.")}})}function reloadReview(e,t){var t=Object.extend({view:"table"},t||{});return e.review&&(e=e.review),null==$("review_"+e.id)?!0:void new Ajax.Request("/review/update/"+e.book_id,{parameters:{format:"json",partial:"bookalike",view:t.view},onSuccess:function(t){$("review_"+e.id).replace(t.responseJSON.html),toggleFieldsToMatchHeader(),$("review_"+e.id).labelized()&&$("review_"+e.id).labelize({force:!0,hoverClass:"checkable",selectedClass:"selected"})}})}function reloadWindow(e){var e=e||{},t=window.location.href.split("#")[0];if(e.without)for(var n=e.without.length-1;n>=0;n--)t=t.replace(e.without[n],"");window.location=t}document.observe("dom:loaded",function(){$$("#fieldsForm input[type=checkbox]").each(function(e){e.observe("click",function(){this.checked?$$(".field."+this.alt).invoke("show"):$$(".field."+this.alt).invoke("hide"),updateFieldSet()})}),$$("#fieldsForm input","#fieldsForm textarea","#fieldsForm select").each(function(e){$(e).observe("change",function(e){updateSessionShelfSettings(),$("save_curr_sett_submit")&&($("save_curr_sett_submit").removeClassName("disabled"),$("save_curr_sett_submit").disabled=!1)})}),"batchEdit"==VISIBLE_CONTROL&&showControl("batchEditLink",{afterOpen:startEditing,afterClose:stopEditing}),INFINITE_SCROLL&&$("infiniteStatus")&&($("infiniteStatus").show(),$("pagestuff").addClassName("infiniteFooter"),Event.observe(window,"scroll",checkInfiniteFooter),$("reviewPagination")&&($("reviewPagination").hide(),InfiniteScroll.start({loading:"infiniteLoading",afterLoad:function(){checkInfiniteFooter(),toggleFieldsToMatchHeader(),$("batchEdit").visible()&&startEditing()}})))}),$j(document).ready(function(){$j("#fieldsForm").bind("ajax:complete",function(){reloadWindow({without:[/[?&]per_page=\d+/,/[?&]sort=\w+/,/[?&]order=\w+/]})}).bind("ajax:beforeSend",function(){$j("#fieldsForm").find(".status").replaceWith(""),$j("#fieldsForm").find(".loading").show(),$j("#save_curr_sett_submit").hide()})});var tipTimers={},ModelEditor=function(){this.recordId=null,this.loading=!1,this.urlBase="/review/update/",this.containerId="reviewForm",this.modelName="review",this.handleAttrName=function(e){return e},this.summon=function(e,t,n,i){var i=i||{};n=this.handleAttrName(n),this.recordId=t;var o=this.containerId,r=this.modelName;$$("#"+o+" .formField").invoke("hide"),$$("#"+o+" input","#"+o+" textarea","#"+o+" select").each(function(e){e.name=e.name.replace(/^_/,""),e.name.indexOf(r+"["+n)>=0?e.value=i.value:(e.name="_"+e.name,e.value="","SELECT"==e.tagName&&(e.selectedIndex=0))});var a=i.reading_session_id;void 0!==a&&""!==a&&($(o).down("#reading_session_id").value=a),$(o).down(".formField."+n).show(),$(e).summon($(o)),"function"==typeof this.afterSummon&&this.afterSummon(e,t,n,i)},this.save=function(){var e=this.recordId,t=this.containerId,n=this,i=$$("#"+t+" .formField").select(function(e){return e.visible()});if(null==e)throw"No ID specified!";if(!this.loading){parameters=Form.serializeElements($$("#"+t+" *"))+"&view="+window.VIEW,""!=EDITABLE_USER_SHELF_NAME&&(parameters+="&shelf="+EDITABLE_USER_SHELF_NAME),parameters+="&fields="+$$("#booksHeader th").map(function(e){return e.getAttribute("alt")}).join(","),this.extraParameters&&(parameters+="&"+this.extraParameters);var o=function(e){var t=JSON.parse(e.responseText),n=t.object,i=t.date_read_markup,o=t.date_started_markup,r=t.reading_session_source_id,a=$$("#review_"+n.id)[0];if(null!==i){var s=null;s=null!==r?a.down(".date_read_"+r):a.down(".date_read .editable_date"),void 0!==s&&(s.parent().innerHTML=i)}if(null!==o){var l=null;l=null!==r?a.down(".date_started_"+r):a.down(".date_started .editable_date"),void 0!==l&&(l.parent().innerHTML=o)}};new Ajax.Request(this.urlBase+e,{parameters:parameters,onLoading:function(){n.loading=!0,$$("#"+t+" .buttons a").invoke("hide"),$(t).down(".loading").show(),$$("#"+t+" .formField").invoke("hide"),$$("#"+t+" input","#"+t+" textarea","#"+t+" select").each(function(e){e.disabled=!0})},onComplete:function(e){n.loading=!1,$$("#"+t+" .buttons a").invoke("show"),$(t).down(".loading").hide(),i.invoke("show"),$$("#"+t+" input","#"+t+" textarea","#"+t+" select").each(function(e){e.disabled=!1}),o(e)},onSuccess:function(e){$(t).hideFloatingBox(),""!=e.responseJSON.error_msg?($("review_list_error_message").show(),$("review_list_error_message").innerHTML=e.responseJSON.error_msg):($("review_list_error_message").hide(),$("review_list_error_message").innerHTML=""),$("review_"+e.responseJSON.object.id).highlight(),toggleFieldsToMatchHeader(),"function"==typeof n.onSuccess&&n.onSuccess(e)}})}}},ReviewEditor=function(){this.recordId=null,this.loading=!1,this.urlBase="/review/update/",this.containerId="reviewForm",this.extraParameters="format=json",this.modelName="review",this.handleAttrName=function(e){return"review"==e?"review_usertext":e},this.afterSummon=function(e,t,n,i){setReadAt({parent:$("reviewForm").down(".formField.read_at"),date:"read_at"==n?i.value:null,clear:"read_at"!=n||null==i.value}),setReadAt({parent:$("reviewForm").down(".formField.started_at"),field_id_prefix:"review_started_at",date:"started_at"==n?i.value:null,clear:"started_at"!=n||null==i.value})}};ReviewEditor.prototype=new ModelEditor;var reviewEditor=new ReviewEditor;OwnedBookEditor=function(){this.recordId=null,this.loading=!1,this.urlBase="/owned_books/update/",this.containerId="ownedBookForm",this.modelName="owned_book",this.extraParameters="review_list=true",this.afterSummon=function(e,t,n,i){setReadAt({parent:$("ownedBookForm").down(".formField.original_purchase_date"),field_id_prefix:"owned_book_original_purchase_date",date:"original_purchase_date"==n?i.value:null,clear:"original_purchase_date"!=n||null==i.value})}},OwnedBookEditor.prototype=new ModelEditor;var ownedBookEditor=new OwnedBookEditor;$j(document).ready(function(){$j(".endOfYearBanner").click(function(e){var t=$j(e.target);t.parents(".sharingLinksInlineContainer").length||(window.location=$j(".endOfYearBanner").data("redirect-url"))})});